#!/bin/bash
# Swarm Pulse - One-Click Setup for RL-Swarm
# Tek komutla her ÅŸeyi halleder!

set -e  # Hata olursa dur

echo "ğŸŒŠ Swarm Pulse - Otomatik Kurulum BaÅŸlÄ±yor..."
echo ""

# 1. rl-swarm container'Ä±nÄ± bul
echo "ğŸ” RL-Swarm container aranÄ±yor..."
CONTAINER=$(docker ps --filter "name=rl-swarm" --format "{{.Names}}" | head -n1)

if [ -z "$CONTAINER" ]; then
    echo "âŒ RL-Swarm container bulunamadÄ±!"
    echo "   Ã–nce rl-swarm'Ä± baÅŸlatÄ±n:"
    echo "   cd ~/rl-swarm && docker-compose run --rm --build -Pit swarm-cpu"
    exit 1
fi

echo "âœ… Container bulundu: $CONTAINER"
echo ""

# 2. Log dosyasÄ±nÄ± oluÅŸtur
LOG_FILE="$HOME/rl-swarm-logs.txt"
echo "ğŸ“ Log dosyasÄ± oluÅŸturuluyor: $LOG_FILE"

# Eski log process'ini durdur
pkill -f "docker logs -f $CONTAINER" 2>/dev/null || true

# Yeni log stream baÅŸlat
nohup docker logs -f "$CONTAINER" > "$LOG_FILE" 2>&1 &
echo "âœ… Docker loglarÄ± dosyaya yÃ¶nlendirildi"
echo ""

# 3. Config dosyasÄ±nÄ± otomatik oluÅŸtur
CONFIG_FILE="config.ini"
echo "âš™ï¸  Config dosyasÄ± oluÅŸturuluyor..."

cat > "$CONFIG_FILE" << EOF
[DEFAULT]
# Auto-generated by setup script
log_file_path = $LOG_FILE
auto_start = true
refresh_interval = 2
EOF

echo "âœ… Config oluÅŸturuldu: $CONFIG_FILE"
echo ""

# 4. Dependencies kontrol et
if ! command -v streamlit &> /dev/null; then
    echo "ğŸ“¦ Streamlit kuruluyor..."
    pip install -q -r requirements.txt
    echo "âœ… Dependencies kuruldu"
else
    echo "âœ… Dependencies zaten kurulu"
fi
echo ""

# 5. Streamlit'i baÅŸlat
echo "ğŸš€ Swarm Pulse baÅŸlatÄ±lÄ±yor..."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… KURULUM TAMAMLANDI!"
echo ""
echo "ğŸ“Š Dashboard: http://localhost:8501"
echo "ğŸ“ Log dosyasÄ±: $LOG_FILE"
echo ""
echo "ğŸ”— SSH Tunnel (local bilgisayardan):"
echo "   ssh -L 8501:localhost:8501 $(whoami)@$(hostname -I | awk '{print $1}')"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Streamlit'i baÅŸlat
streamlit run app.py --server.address=0.0.0.0 --server.port=8501
